##@ General

.PHONY: help
help: ## Display this help.
	@echo ""
	@echo "ğŸš€ Terafy Deploy - Makefile"
	@echo ""
	@echo "Commands:"
	@echo "  make all [VM_NAME=xxx] - Build, deploy and connect to VM (default: terafy-freetier-vm)"
	@echo "  make build          - Build terafy-deploy-x.x.x.tar.gz"
	@echo "  make deploy [VM_NAME=xxx] - Copy package and script to VM (default: terafy-freetier-vm)"
	@echo "  make clean          - Remove build artifacts"
	@echo "  make gcloud [VM_NAME=xxx] - Connect to VM (default: terafy-freetier-vm)"
	@echo "  make scp FILE=xxx [VM_NAME=xxx] - Copy file to VM (default: terafy-freetier-vm)"
	@echo "  make firewall-postgres [VM_NAME=xxx] - Create firewall rule for PostgreSQL access"
	@echo ""

##@ Build

.PHONY: all
all: ## Build, deploy and connect to VM (default: terafy-freetier-vm).
	@VM_NAME=$${VM_NAME:-terafy-freetier-vm}; \
	echo "ğŸš€ Building, deploying and connecting to $$VM_NAME..."; \
	echo ""; \
	echo "ğŸ“¦ Step 1: Building package..."; \
	$(MAKE) build; \
	echo ""; \
	echo "ğŸš€ Step 2: Deploying to $$VM_NAME..."; \
	VM_NAME=$$VM_NAME $(MAKE) deploy; \
	echo ""; \
	echo "ğŸ”Œ Step 3: Connecting to $$VM_NAME..."; \
	VM_NAME=$$VM_NAME $(MAKE) gcloud

.PHONY: build
build: ## Build terafy-deploy-x.x.x.tar.gz package.
	@echo "ğŸ“¦ Building deploy package..."
	@./prepare-deploy.sh

##@ Deploy

.PHONY: deploy
deploy: ## Copy package and update-binario.sh to VM (default: terafy-freetier-vm).
	@VM_NAME=$${VM_NAME:-terafy-freetier-vm}; \
	PACKAGE=$$(ls -t terafy-deploy-*.tar.gz 2>/dev/null | head -1); \
	if [ -z "$$PACKAGE" ]; then \
		echo "âŒ Error: No package found. Run 'make build' first."; \
		exit 1; \
	fi; \
	echo "ğŸš€ Deploying to $$VM_NAME..."; \
	echo "ğŸ“¦ Copying $$PACKAGE..."; \
	gcloud compute scp "$$PACKAGE" "$$VM_NAME:~/"; \
	echo "ğŸ“œ Copying update-binario.sh..."; \
	gcloud compute scp update-binario.sh "$$VM_NAME:~/"; \
	echo "âœ… Deploy completed!"

##@ Cleanup

.PHONY: clean
clean: ## Remove build artifacts.
	@echo "ğŸ§¹ Cleaning..."
	@rm -rf build/
	@rm -rf terafy-deploy/
	@rm -f terafy-deploy*.tar.gz
	@echo "âœ… Clean completed"

##@ Google Cloud

.PHONY: gcloud
gcloud: ## Connect to VM via SSH (default: terafy-freetier-vm).
	@VM_NAME=$${VM_NAME:-terafy-freetier-vm}; \
	echo "ğŸ”Œ Connecting to $$VM_NAME..."; \
	gcloud compute ssh $$VM_NAME

.PHONY: scp
scp: ## Copy file to VM (requires FILE variable, default VM: terafy-freetier-vm).
	@if [ -z "$(FILE)" ]; then \
		echo "âŒ Error: FILE is required. Usage: make scp FILE=fix-db-ownership.sh"; \
		exit 1; \
	fi; \
	if [ ! -f "$(FILE)" ]; then \
		echo "âŒ Error: File not found: $(FILE)"; \
		exit 1; \
	fi; \
	VM_NAME=$${VM_NAME:-terafy-freetier-vm}; \
	echo "ğŸ“¤ Copying $(FILE) to $$VM_NAME..."; \
	gcloud compute scp "$(FILE)" "$$VM_NAME:~/"; \
	echo "âœ… File copied!"
