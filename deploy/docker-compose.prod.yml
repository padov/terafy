version: '3.8'

# Docker Compose para PRODUÇÃO no Google Cloud
# Este arquivo assume que você está usando Cloud SQL (não PostgreSQL local)

services:
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: terafy_server
    restart: unless-stopped
    environment:
      # IMPORTANTE: Ajuste essas variáveis para seu Cloud SQL
      - DB_HOST=${DB_HOST}  # IP privado ou connection name do Cloud SQL
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-terafy_db}
      - DB_USER=${DB_USER:-postgres}
      - DB_PASSWORD=${DB_PASSWORD}  # Use Secret Manager em produção!
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}  # Use Secret Manager em produção!
      - JWT_EXPIRATION_DAYS=${JWT_EXPIRATION_DAYS:-7}
      - DB_SSL_MODE=require  # SSL obrigatório em produção
    ports:
      - '${SERVER_PORT:-8080}:8080'
    # Remove depends_on do postgres_db pois não existe mais
    volumes:
      # Monta migrations para possível execução manual
      - ../server/db/migrations:/app/migrations:ro

  # Nginx como reverse proxy (recomendado para produção)
  nginx:
    image: nginx:alpine
    container_name: terafy_nginx
    restart: unless-stopped
    ports:
      - '${NGINX_HTTP_PORT:-80}:80'
      - '${NGINX_HTTPS_PORT:-443}:443'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro  # Certificados SSL
    depends_on:
      - server
    profiles:
      - with-nginx

